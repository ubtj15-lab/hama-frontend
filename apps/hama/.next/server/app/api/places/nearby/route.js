"use strict";(()=>{var e={};e.id=5832,e.ids=[5832],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9655:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>k,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var t={};r.r(t),r.d(t,{GET:()=>m});var n=r(3036),l=r(5736),o=r(5262),s=r(942),i=r(851);function u(e){let a=Number(e);return Number.isFinite(a)?a:null}function c(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!a)throw Error("Missing SUPABASE env");return(0,i.eI)(e,a,{auth:{persistSession:!1}})}async function d(e){let a=c(),{lat:r,lng:t,tab:n,radiusKm:l,limit:o}=e,s=l/111,i=l/(111*Math.cos(r*Math.PI/180)),u=a.from("stores").select(`
      id,
      name,
      category,
      area,
      address,
      lat,
      lng,
      phone,
      image_url,
      kakao_place_url,
      naver_place_id,
      mood,
      tags,
      curated_score,
      updated_at,
      source,
      place_key
    `).gte("lat",r-s).lte("lat",r+s).gte("lng",t-i).lte("lng",t+i).limit(o);"all"!==n&&(u=u.eq("category",n)),u=u.order("curated_score",{ascending:!1,nullsFirst:!1}).order("updated_at",{ascending:!1,nullsFirst:!1});let{data:d,error:p}=await u;return p?(console.error("[dbNearbyPool]",p),[]):d??[]}async function p(e){var a;let r=process.env.KAKAO_REST_API_KEY;if(!r)throw Error("Missing KAKAO_REST_API_KEY");let t="cafe"===(a=e.tab)?"CE7":"restaurant"===a?"FD6":null;if(!t)return[];let n=Math.min(Math.max(Math.floor(1e3*e.radiusKm),100),2e4),l=new URL("https://dapi.kakao.com/v2/local/search/category.json");l.searchParams.set("category_group_code",t),l.searchParams.set("x",String(e.lng)),l.searchParams.set("y",String(e.lat)),l.searchParams.set("radius",String(n)),l.searchParams.set("size",String(Math.min(e.size,15))),l.searchParams.set("sort","distance");let o=await fetch(l.toString(),{headers:{Authorization:`KakaoAK ${r}`},cache:"no-store"});if(!o.ok){let e=await o.text().catch(()=>"");return console.error("[kakaoNearby] fail",o.status,e),[]}let s=await o.json();return Array.isArray(s?.documents)?s.documents:[]}function g(e){return{id:e.id,name:e.name??"",category:e.category??null,categoryLabel:"restaurant"===e.category?"식당":"cafe"===e.category?"카페":"salon"===e.category?"미용":"activity"===e.category?"액티비티":"장소",area:e.area??null,address:e.address??null,lat:e.lat??null,lng:e.lng??null,phone:e.phone??null,image_url:e.image_url??null,imageUrl:e.image_url??null,kakao_place_url:e.kakao_place_url??null,naver_place_id:e.naver_place_id??null,mood:Array.isArray(e.mood)?e.mood:[],moodText:Array.isArray(e.mood)?e.mood.slice(0,2).join(" \xb7 "):"",tags:Array.isArray(e.tags)?e.tags:[],curated_score:"number"==typeof e.curated_score?e.curated_score:0,updated_at:e.updated_at??null,source:e.source??null,place_key:e.place_key??null}}async function m(e){try{let{searchParams:a}=new URL(e.url),r=Number(a.get("lat")),t=Number(a.get("lng")),n=a.get("tab")??"all",l=Number(a.get("radiusKm")??"4"),o=Number(a.get("limit")??"40");if(!Number.isFinite(r)||!Number.isFinite(t))return s.NextResponse.json({ok:!1,error:"invalid lat/lng"},{status:400});if(!["all","restaurant","cafe","salon","activity"].includes(n))return s.NextResponse.json({ok:!1,error:"invalid tab"},{status:400});let i=await d({lat:r,lng:t,tab:n,radiusKm:l,limit:o}),m=Math.max(0,o-i.length),_=i;if(m>0){let e=c(),a=[],s=m;for(;s>0;){let e=Math.min(s,15),o=await p({lat:r,lng:t,tab:n,radiusKm:l,size:e});if(!o.length||(a=a.concat(o),s-=o.length,o.length<e))break}if(a.length>0){let s=a.map(e=>(function(e,a){let r=e?.place_name??null,t=e?.road_address_name??e?.address_name??null,n=e?.phone??null,l=u(e?.y),o=u(e?.x),s=e?.place_url??null,i=e?.id?String(e.id):null;return{name:r,category:"all"===a?null:a,area:function(e){if(!e)return null;let a=e.split(" ").filter(Boolean);return a.length>=2?`${a[0]} ${a[1]}`:a[0]??null}(t),address:t,lat:l,lng:o,phone:n,image_url:null,kakao_place_url:s,naver_place_id:null,mood:[],tags:[],with_kids:null,for_work:null,reservation_required:null,price_level:null,curated_score:0,updated_at:new Date().toISOString(),source:"kakao",place_key:i}})(e,n)).filter(e=>e.place_key&&e.name&&null!=e.lat&&null!=e.lng);if(s.length>0){let{error:a}=await e.from("stores").upsert(s,{onConflict:"place_key"});a&&console.error("[kakao upsert]",a)}_=await d({lat:r,lng:t,tab:n,radiusKm:l,limit:o})}}let h=_.map(g);return s.NextResponse.json({ok:!0,cards:h})}catch(e){return console.error("[/api/places/nearby]",e),s.NextResponse.json({ok:!1,error:e?.message??"unknown"},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/places/nearby/route",pathname:"/api/places/nearby",filename:"route",bundlePath:"app/api/places/nearby/route"},resolvedPagePath:"C:\\Users\\ubtj1\\hama-frontend\\apps\\hama\\app\\api\\places\\nearby\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:f}=_,k="/api/places/nearby/route";function b(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[4522,1746,851],()=>r(9655));module.exports=t})();