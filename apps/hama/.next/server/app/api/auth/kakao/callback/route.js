"use strict";(()=>{var e={};e.id=1615,e.ids=[1615],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1914:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>k,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{GET:()=>p});var o=a(3036),s=a(5736),n=a(5262),i=a(942),u=a(851);let c=process.env.NEXT_PUBLIC_SUPABASE_URL,l=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;async function p(e){let t=(process.env.KAKAO_REST_API_KEY||"").trim(),a=function(e){let t=e.headers.get("host")||e.headers.get("x-forwarded-host"),a=e.headers.get("x-forwarded-proto")||(t?.includes("localhost")?"http":"https");return t?`${a}://${t}/api/auth/kakao/callback`:(process.env.NEXT_PUBLIC_KAKAO_REDIRECT_URI||"").trim()||"http://localhost:3000/api/auth/kakao/callback"}(e);if(!t||!a)return new Response("Kakao env not set",{status:500});let r=e.nextUrl.searchParams.get("code"),o=e.nextUrl.searchParams.get("state");if(!r)return new Response("No code from kakao",{status:400});let s=o?decodeURIComponent(o):"",n=await fetch("https://kauth.kakao.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:t,redirect_uri:a,code:r})});if(!n.ok)return new Response("Failed to get token from kakao",{status:500});let p=(await n.json()).access_token;if(!p)return new Response("No access token from kakao",{status:500});let d=await fetch("https://kapi.kakao.com/v2/user/me",{headers:{Authorization:`Bearer ${p}`}});if(!d.ok){let t=s.startsWith("/")?s:"/";return i.NextResponse.redirect(new URL(t,e.url))}let k=await d.json(),h=String(k?.id??""),m=k?.kakao_account?.profile?.nickname??k?.properties?.nickname??"카카오 사용자",_=c&&l?(0,u.eI)(c,l):null,f=null;if(_&&h){let{data:e}=await _.from("users").select("id").eq("kakao_id",h).single();if(e)f=e.id,await _.from("users").update({nickname:m,updated_at:new Date().toISOString()}).eq("id",f);else{let{data:e,error:t}=await _.from("users").insert({kakao_id:h,nickname:m,role:"consumer"}).select("id").single();!t&&e&&(f=e.id)}}let w=s.startsWith("/")?s:"/",g=i.NextResponse.redirect(new URL(w,e.url));return f&&(g.cookies.set("hama_user_id",f,{path:"/",maxAge:2592e3,sameSite:"lax"}),g.cookies.set("hama_user_nickname",encodeURIComponent(m),{path:"/",maxAge:2592e3,sameSite:"lax"})),g}let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/kakao/callback/route",pathname:"/api/auth/kakao/callback",filename:"route",bundlePath:"app/api/auth/kakao/callback/route"},resolvedPagePath:"C:\\Users\\ubtj1\\hama-frontend\\apps\\hama\\app\\api\\auth\\kakao\\callback\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:k,staticGenerationAsyncStorage:h,serverHooks:m}=d,_="/api/auth/kakao/callback/route";function f(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[4522,1746,851],()=>a(1914));module.exports=r})();